<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>СИСТЕМА 800x480</title>
    <style>
        /* --- СТИЛЬ РЕТРО ОС --- */
        :root {
            --bg-color: #ffffff;
            --fg-color: #000000;
            --border-thick: 3px solid var(--fg-color);
            --border-thin: 1px solid var(--fg-color);
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            padding: 0;
            background-color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: 'Courier New', Courier, monospace;
            color: var(--fg-color);
            -webkit-font-smoothing: none;
        }

        #screen {
            width: 800px;
            height: 480px;
            background-color: var(--bg-color);
            border: var(--border-thick);
            display: flex;
            overflow: hidden;
            position: relative;
        }

        #screen::after {
            content: " ";
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
            background-size: 100% 4px;
            z-index: 10;
            pointer-events: none;
        }

        .panel {
            width: 50%;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 10px;
        }

        .panel-left { border-right: var(--border-thick); }
        .panel-right { display: flex; flex-direction: column; }

        .window-header {
            background-color: var(--fg-color);
            color: var(--bg-color);
            padding: 4px 8px;
            text-transform: uppercase;
            font-weight: bold;
            letter-spacing: 1px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .window-header .btn {
            border: 1px solid var(--bg-color);
            width: 14px;
            height: 14px;
            background: var(--bg-color);
        }

        .content-area { flex-grow: 1; padding-right: 5px; }
        #weather-content { overflow-y: auto; }
        #news-content { overflow: hidden; flex-grow: 1; }

        /* --- НОВЫЙ МОДУЛЬ: КАЛЕНДАРЬ И ИНФО --- */
        .dashboard-footer {
            border-top: var(--border-thick);
            padding-top: 8px;
            margin-top: 5px;
            height: 130px; /* Фиксированная высота */
            flex-shrink: 0;
            display: flex;
            gap: 10px;
        }

        .cal-container {
            width: 60%;
            font-size: 12px;
        }

        .astro-container {
            width: 40%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            font-size: 12px;
            border-left: 1px dashed var(--fg-color);
            padding-left: 10px;
        }

        table.calendar {
            width: 100%;
            border-collapse: collapse;
            text-align: center;
        }
        
        table.calendar th { border-bottom: 1px solid var(--fg-color); padding-bottom: 2px; }
        table.calendar td { padding: 2px 0; }
        
        .today-cell {
            background-color: var(--fg-color);
            color: var(--bg-color);
            font-weight: bold;
        }

        .info-row { margin-bottom: 6px; }
        .info-label { text-decoration: underline; margin-bottom: 2px; }
        .info-val { font-weight: bold; font-size: 14px; }

        .snapshot-time {
            margin-top: auto;
            font-size: 10px;
            text-align: right;
            opacity: 0.7;
        }

        /* ТИПОГРАФИКА */
        .section-title {
            border-bottom: var(--border-thick);
            margin-bottom: 8px;
            padding-bottom: 2px;
            font-weight: bold;
        }

        .weather-row {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px dashed var(--fg-color);
            padding: 4px 0;
            font-size: 14px;
        }
        .weather-row:last-child { border-bottom: none; }
        
        .forecast-box {
            border: var(--border-thin);
            margin-top: 15px;
            padding: 5px;
        }

        .news-item { margin-bottom: 12px; line-height: 1.1; }
        .news-date { font-size: 0.8em; text-decoration: underline; margin-bottom: 2px; }
        .news-title { font-weight: bold; font-size: 13px; }

        .loading { text-align: center; padding-top: 50px; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 12px; }
        ::-webkit-scrollbar-track {
            border-left: var(--border-thin);
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="4" height="4" viewBox="0 0 4 4"><rect width="1" height="1" x="0" y="0" fill="black"/><rect width="1" height="1" x="2" y="2" fill="black"/></svg>');
        }
        ::-webkit-scrollbar-thumb { background: var(--fg-color); border: 2px solid var(--bg-color); }
    </style>
</head>
<body>

    <div id="screen">
        
        <!-- ЛЕВАЯ ПАНЕЛЬ: ПОГОДА -->
        <div class="panel panel-left">
            <div class="window-header">
                <span>РОСТОВ_МЕТЕО.EXE</span>
                <span class="btn"></span>
            </div>
            
            <div class="content-area" id="weather-content">
                <div class="loading">ЗАГРУЗКА ДАННЫХ...</div>
            </div>
        </div>

        <!-- ПРАВАЯ ПАНЕЛЬ: НОВОСТИ + КАЛЕНДАРЬ -->
        <div class="panel panel-right">
            <div class="window-header">
                <span>НОВОСТИ.TXT</span>
                <span class="btn"></span>
            </div>

            <!-- Новости (Верх) -->
            <div class="content-area" id="news-content">
                <div class="loading">ПОИСК СЕТИ...</div>
            </div>

            <!-- Календарь и Астро (Низ) -->
            <div class="dashboard-footer">
                
                <div class="cal-container">
                    <div style="font-weight:bold; margin-bottom:5px; text-align:center;" id="cal-month-name">MONTH</div>
                    <table class="calendar" id="cal-table">
                        <!-- Calendar generated by JS -->
                    </table>
                </div>

                <div class="astro-container">
                    <div class="info-row">
                        <div class="info-label">ВОСХОД:</div>
                        <div class="info-val" id="sun-rise">--:--</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">ЗАКАТ:</div>
                        <div class="info-val" id="sun-set">--:--</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">СВЕТОВОЙ ДЕНЬ:</div>
                        <div class="info-val" id="day-len">-- ч</div>
                    </div>
                    <div class="snapshot-time" id="snap-time">UPD: --:--</div>
                </div>

            </div>
        </div>

    </div>

<script>
    /* --- ПОГОДНЫЙ КОД --- */
    function getWeatherDesc(code) {
        const codes = {
            0: "ЯСНО", 1: "ПРЕИМ. ЯСНО", 2: "ПЕРЕМ. ОБЛАЧНОСТЬ", 3: "ПАСМУРНО",
            45: "ТУМАН", 48: "ИЗМОРОЗЬ", 51: "МОРОСЬ", 53: "МОРОСЬ", 55: "МОРОСЬ",
            61: "ДОЖДЬ", 63: "ДОЖДЬ", 65: "ЛИВЕНЬ", 71: "СНЕГ", 73: "СНЕГ", 75: "СНЕГОПАД",
            80: "ЛИВЕНЬ", 95: "ГРОЗА", 96: "ГРОЗА С ГРАДОМ"
        };
        return codes[code] || "НЕИЗВЕСТНО";
    }

    /* --- ГЕНЕРАЦИЯ КАЛЕНДАРЯ --- */
    function renderCalendar() {
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth();
        const today = now.getDate();

        // Название месяца
        const monthNames = ["ЯНВАРЬ", "ФЕВРАЛЬ", "МАРТ", "АПРЕЛЬ", "МАЙ", "ИЮНЬ", "ИЮЛЬ", "АВГУСТ", "СЕНТЯБРЬ", "ОКТЯБРЬ", "НОЯБРЬ", "ДЕКАБРЬ"];
        document.getElementById('cal-month-name').innerText = `${monthNames[month]} ${year}`;

        const firstDay = new Date(year, month, 1).getDay(); // 0=Sun, 1=Mon
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // Коррекция для понедельника (Mon=0 в нашем календаре)
        let startCol = firstDay === 0 ? 6 : firstDay - 1;

        let html = `<thead><tr>
            <th>ПН</th><th>ВТ</th><th>СР</th><th>ЧТ</th><th>ПТ</th><th>СБ</th><th>ВС</th>
        </tr></thead><tbody><tr>`;

        // Пустые ячейки до 1 числа
        for (let i = 0; i < startCol; i++) {
            html += `<td></td>`;
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const isToday = day === today ? 'class="today-cell"' : '';
            html += `<td ${isToday}>${day}</td>`;

            if ((day + startCol) % 7 === 0) {
                html += `</tr><tr>`;
            }
        }
        html += `</tr></tbody>`;
        document.getElementById('cal-table').innerHTML = html;
    }

    /* --- ПОЛУЧЕНИЕ ПОГОДЫ И АСТРО-ДАННЫХ --- */
    async function fetchWeather() {
        // Добавили sunrise/sunset в запрос
        const url = "https://api.open-meteo.com/v1/forecast?latitude=47.2357&longitude=39.7015&hourly=temperature_2m,weathercode&daily=weathercode,temperature_2m_max,temperature_2m_min,sunrise,sunset&timezone=Europe%2FMoscow";
        
        try {
            const response = await fetch(url);
            const data = await response.json();
            
            const idxMorning = 9; const idxAfternoon = 14; const idxEvening = 20; 

            const todayTemp = {
                m: Math.round(data.hourly.temperature_2m[idxMorning]),
                a: Math.round(data.hourly.temperature_2m[idxAfternoon]),
                e: Math.round(data.hourly.temperature_2m[idxEvening]),
                code: data.hourly.weathercode[idxAfternoon]
            };

            // Рендер прогноза
            let forecastHTML = "";
            for(let i=1; i<=5; i++) {
                const dateRaw = new Date(data.daily.time[i]);
                const dateStr = dateRaw.toLocaleDateString('ru-RU', {weekday: 'short', day: 'numeric'}).toUpperCase();
                const min = Math.round(data.daily.temperature_2m_min[i]);
                const max = Math.round(data.daily.temperature_2m_max[i]);
                const desc = getWeatherDesc(data.daily.weathercode[i]);

                forecastHTML += `
                <div class="weather-row">
                    <span style="min-width: 80px;">${dateStr}</span>
                    <span style="flex-grow:1; text-align:center;">${desc}</span>
                    <span>${min}/${max}°C</span>
                </div>`;
            }

            const todayDate = new Date().toLocaleDateString('ru-RU').toUpperCase();

            document.getElementById('weather-content').innerHTML = `
                <div class="section-title">СЕГОДНЯ: РОСТОВ-НА-ДОНУ</div>
                <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-weight:bold; font-size:1.2em;">
                    <span>${todayDate}</span>
                </div>
                <div class="forecast-box">
                    <div class="weather-row"><span>УТРО (09:00)</span><span>${todayTemp.m > 0 ? '+' : ''}${todayTemp.m}°C</span></div>
                    <div class="weather-row"><span>ДЕНЬ (14:00)</span><span>${todayTemp.a > 0 ? '+' : ''}${todayTemp.a}°C</span></div>
                    <div class="weather-row"><span>ВЕЧЕР (20:00)</span><span>${todayTemp.e > 0 ? '+' : ''}${todayTemp.e}°C</span></div>
                    <div style="text-align:center; margin-top:5px; font-style:italic;">${getWeatherDesc(todayTemp.code)}</div>
                </div>
                <br>
                <div class="section-title">ПРОГНОЗ НА 5 ДНЕЙ</div>
                ${forecastHTML}
            `;

            // --- ОБНОВЛЕНИЕ АСТРО-ДАННЫХ (FOOTER) ---
            // Сегодняшний индекс = 0
            const sunrise = new Date(data.daily.sunrise[0]).toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'});
            const sunset = new Date(data.daily.sunset[0]).toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'});
            
            // Расчет длины дня
            const dayDurationMs = new Date(data.daily.sunset[0]) - new Date(data.daily.sunrise[0]);
            const hours = Math.floor(dayDurationMs / 3600000);
            const mins = Math.round((dayDurationMs % 3600000) / 60000);

            document.getElementById('sun-rise').innerText = sunrise;
            document.getElementById('sun-set').innerText = sunset;
            document.getElementById('day-len').innerText = `${hours}ч ${mins}м`;

        } catch (e) {
            console.error(e);
            document.getElementById('weather-content').innerHTML = `<div class="loading">ОШИБКА ДАТЧИКА</div>`;
        }
    }

    /* --- НОВОСТИ --- */
    async function fetchNews() {
        const rssUrl = "https://lenta.ru/rss/news";
        const apiUrl = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rssUrl)}`;

        try {
            const response = await fetch(apiUrl);
            const data = await response.json();
            if(data.status !== 'ok') throw new Error("API Error");

            let newsHTML = `<div class="section-title">ГЛАВНОЕ К ЭТОМУ ЧАСУ</div>`;

            // 4 новости для баланса высоты
            data.items.slice(0, 4).forEach(item => {
                const dateObj = new Date(item.pubDate);
                dateObj.setHours(dateObj.getHours() + 3); // +3 часа коррекция
                const timeStr = dateObj.toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'});
                
                newsHTML += `
                <div class="news-item">
                    <div class="news-date">>> ${timeStr}</div>
                    <div class="news-title">${item.title.toUpperCase()}</div>
                </div>`;
            });

            document.getElementById('news-content').innerHTML = newsHTML;
        } catch (e) {
            document.getElementById('news-content').innerHTML = `<div class="loading">ОШИБКА СВЯЗИ</div>`;
        }
    }

    // ФИКСАЦИЯ ВРЕМЕНИ СНИМКА (СТАТИЧНО)
    function setSnapshotTime() {
        const now = new Date();
        const str = now.toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'});
        document.getElementById('snap-time').innerText = `СНИМОК: ${str}`;
    }

    // ЗАПУСК
    window.onload = () => {
        renderCalendar();
        setSnapshotTime(); // Установить время загрузки страницы
        fetchWeather();
        fetchNews();
    };

</script>
</body>
</html>
